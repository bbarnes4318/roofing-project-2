# NGINX Configuration for Roofing Project Application
# Location: /etc/nginx/sites-available/roofing-app
# or: /etc/nginx/conf.d/roofing-app.conf
#
# IMPORTANT: This is a reference configuration. Adjust paths and domains for your environment.
#
# After editing:
# 1. Test configuration: sudo nginx -t
# 2. Reload NGINX: sudo systemctl reload nginx
# 3. Check logs: sudo tail -f /var/log/nginx/error.log

server {
    listen 80;
    listen [::]:80;
    
    # IMPORTANT: Replace with your actual domain
    server_name your-domain.com www.your-domain.com;
    
    # Maximum upload size (adjust as needed)
    client_max_body_size 50M;
    
    # Logging
    access_log /var/log/nginx/roofing-app-access.log;
    error_log /var/log/nginx/roofing-app-error.log;

    # ========================================================================
    # STATIC FILE SERVING FOR UPLOADS
    # ========================================================================
    # This serves uploaded documents directly from NGINX (bypasses Node.js)
    # for better performance and reduced server load
    
    location /uploads/ {
        # IMPORTANT: Replace this path with your actual uploads directory
        # Common paths on Digital Ocean:
        # - /var/www/roofing-app/uploads
        # - /home/deploy/roofing-app/uploads
        # - /app/uploads (if using Docker)
        # - /workspace/server/uploads (if using App Platform)
        alias /var/www/your-app-name/uploads/;
        
        # Enable CORS for uploaded files (allows frontend to access files)
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept" always;
        
        # Cache uploaded files for 1 day (improves performance)
        expires 1d;
        add_header Cache-Control "public, immutable";
        
        # Security headers
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-XSS-Protection "1; mode=block" always;
        
        # Disable directory listing (security)
        autoindex off;
        
        # Try to serve the file, return 404 if not found
        try_files $uri =404;
        
        # Separate logging for uploads (useful for debugging)
        access_log /var/log/nginx/uploads-access.log;
        error_log /var/log/nginx/uploads-error.log;
        
        # Prevent execution of scripts in uploads directory (security)
        location ~ \.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$ {
            deny all;
        }
    }

    # ========================================================================
    # PROXY TO NODE.JS APPLICATION
    # ========================================================================
    # All other requests are proxied to the Node.js/Express server
    
    location / {
        # IMPORTANT: Adjust port if your Node.js app runs on a different port
        proxy_pass http://localhost:5000;
        
        # WebSocket support (required for Socket.io)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # Forward original request information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Don't cache proxied requests
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts (adjust as needed)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ========================================================================
    # OPTIONAL: SERVE REACT BUILD FILES FROM NGINX
    # ========================================================================
    # If you want NGINX to serve your React build files instead of Node.js
    # (better performance), uncomment and configure this section:
    
    # location / {
    #     # IMPORTANT: Replace with your React build directory
    #     root /var/www/your-app-name/build;
    #     index index.html;
    #     try_files $uri $uri/ /index.html;
    #     
    #     # Cache static assets
    #     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    #         expires 1y;
    #         add_header Cache-Control "public, immutable";
    #     }
    # }
    # 
    # # API requests go to Node.js
    # location /api/ {
    #     proxy_pass http://localhost:5000;
    #     proxy_http_version 1.1;
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection 'upgrade';
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_cache_bypass $http_upgrade;
    # }
}

# ============================================================================
# SSL/HTTPS CONFIGURATION (RECOMMENDED FOR PRODUCTION)
# ============================================================================
# After setting up SSL with Let's Encrypt (certbot), this block will be added:

# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     
#     server_name your-domain.com www.your-domain.com;
#     
#     # SSL certificates (managed by certbot)
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#     
#     # ... (same configuration as above)
# }
# 
# # Redirect HTTP to HTTPS
# server {
#     listen 80;
#     listen [::]:80;
#     server_name your-domain.com www.your-domain.com;
#     return 301 https://$server_name$request_uri;
# }

# ============================================================================
# INSTALLATION INSTRUCTIONS
# ============================================================================
# 
# 1. Copy this file to NGINX sites-available:
#    sudo cp nginx-config-example.conf /etc/nginx/sites-available/roofing-app
# 
# 2. Edit the file and replace placeholders:
#    sudo nano /etc/nginx/sites-available/roofing-app
#    - Replace "your-domain.com" with your actual domain
#    - Replace "/var/www/your-app-name/uploads/" with your actual uploads path
#    - Adjust port (5000) if your Node.js app uses a different port
# 
# 3. Create symbolic link to enable the site:
#    sudo ln -s /etc/nginx/sites-available/roofing-app /etc/nginx/sites-enabled/
# 
# 4. Test NGINX configuration:
#    sudo nginx -t
# 
# 5. Reload NGINX:
#    sudo systemctl reload nginx
# 
# 6. Check NGINX status:
#    sudo systemctl status nginx
# 
# 7. Monitor logs for issues:
#    sudo tail -f /var/log/nginx/error.log
#    sudo tail -f /var/log/nginx/uploads-error.log
# 
# 8. Test file access:
#    curl -I https://your-domain.com/uploads/company-assets/test.pdf
# 
# ============================================================================
# TROUBLESHOOTING
# ============================================================================
# 
# Issue: 404 Not Found
# - Verify the alias path is correct: ls -la /var/www/your-app-name/uploads/
# - Check NGINX error log: sudo tail -f /var/log/nginx/uploads-error.log
# - Ensure files exist in the correct location
# 
# Issue: 403 Forbidden
# - Check file permissions: sudo chmod -R 755 /var/www/your-app-name/uploads
# - Check ownership: sudo chown -R www-data:www-data /var/www/your-app-name/uploads
# - Verify NGINX user has read access: sudo -u www-data ls /var/www/your-app-name/uploads/
# 
# Issue: 502 Bad Gateway
# - Verify Node.js app is running: sudo systemctl status your-app-service
# - Check if port 5000 is listening: sudo netstat -tlnp | grep 5000
# - Review Node.js logs: sudo journalctl -u your-app-service -f
# 
# Issue: WebSocket connection fails
# - Ensure proxy_http_version 1.1 is set
# - Verify Upgrade and Connection headers are set
# - Check browser console for WebSocket errors
# 
# ============================================================================

