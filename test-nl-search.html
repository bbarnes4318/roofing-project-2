<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natural Language Search Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .search-section {
            margin-bottom: 30px;
        }
        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .search-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .test-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .test-query {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        .test-query:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        .results-section {
            margin-top: 20px;
        }
        .result-item {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .result-subtitle {
            color: #666;
            margin-bottom: 5px;
        }
        .result-meta {
            font-size: 12px;
            color: #999;
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .nlp-indicator {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .conventional-indicator {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ AI-Powered Natural Language Search Test</h1>
        <p>Test the new natural language search capabilities. Try asking questions in natural language!</p>

        <div class="search-section">
            <input 
                type="text" 
                id="searchInput" 
                class="search-input" 
                placeholder="Try: 'show me completed projects from last month'"
            >
            
            <h3>Example Queries:</h3>
            <div class="test-queries">
                <div class="test-query" onclick="testQuery('show me completed projects')">
                    üìã Show me completed projects
                </div>
                <div class="test-query" onclick="testQuery('find projects from last month')">
                    üìÖ Find projects from last month
                </div>
                <div class="test-query" onclick="testQuery('show me all roofing projects')">
                    üè† Show me all roofing projects
                </div>
                <div class="test-query" onclick="testQuery('find customer John Smith')">
                    üë§ Find customer John Smith
                </div>
                <div class="test-query" onclick="testQuery('projects in progress')">
                    üîÑ Projects in progress
                </div>
                <div class="test-query" onclick="testQuery('show me lead phase projects')">
                    üéØ Show me lead phase projects
                </div>
                <div class="test-query" onclick="testQuery('completed roofs from this year')">
                    ‚úÖ Completed roofs from this year
                </div>
                <div class="test-query" onclick="testQuery('project 12345')">
                    üîç Project 12345
                </div>
            </div>
        </div>

        <div class="results-section">
            <h3>Search Results:</h3>
            <div id="results"></div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const resultsDiv = document.getElementById('results');

        // Test data (simulating the search service data structure)
        const testData = {
            projects: [
                {
                    id: 1,
                    projectNumber: '12345',
                    name: 'Roof Replacement',
                    address: '123 Main St, Anytown, USA',
                    phase: 'COMPLETED',
                    status: 'COMPLETED',
                    projectType: 'roof',
                    createdAt: new Date('2024-12-15'),
                    customer: {
                        name: 'John Smith',
                        primaryName: 'John Smith',
                        phone: '(555) 123-4567',
                        email: 'john@email.com'
                    }
                },
                {
                    id: 2,
                    projectNumber: '12346',
                    name: 'Roof Repair',
                    address: '456 Oak Ave, Somewhere, USA',
                    phase: 'IN_PROGRESS',
                    status: 'IN_PROGRESS',
                    projectType: 'repair',
                    createdAt: new Date('2025-01-10'),
                    customer: {
                        name: 'Jane Doe',
                        primaryName: 'Jane Doe',
                        phone: '(555) 987-6543',
                        email: 'jane@email.com'
                    }
                },
                {
                    id: 3,
                    projectNumber: '12347',
                    name: 'New Roof Installation',
                    address: '789 Pine Rd, Elsewhere, USA',
                    phase: 'LEAD',
                    status: 'NOT_STARTED',
                    projectType: 'installation',
                    createdAt: new Date('2025-02-01'),
                    customer: {
                        name: 'Bob Johnson',
                        primaryName: 'Bob Johnson',
                        phone: '(555) 456-7890',
                        email: 'bob@email.com'
                    }
                }
            ],
            activities: []
        };

        // Mock NLP Manager for testing
        class MockNLPManager {
            async process(lang, query) {
                const queryLower = query.toLowerCase();
                
                // Simple intent detection for testing
                if (queryLower.includes('completed')) {
                    return {
                        intent: 'search.by.status',
                        score: 0.9,
                        entities: [{
                            entity: 'status',
                            resolution: { value: 'completed' },
                            sourceText: 'completed'
                        }]
                    };
                }
                
                if (queryLower.includes('progress')) {
                    return {
                        intent: 'search.by.status',
                        score: 0.9,
                        entities: [{
                            entity: 'status',
                            resolution: { value: 'in-progress' },
                            sourceText: 'progress'
                        }]
                    };
                }
                
                if (queryLower.includes('lead')) {
                    return {
                        intent: 'search.by.phase',
                        score: 0.9,
                        entities: [{
                            entity: 'phase',
                            resolution: { value: 'LEAD' },
                            sourceText: 'lead'
                        }]
                    };
                }
                
                if (queryLower.includes('last month')) {
                    return {
                        intent: 'search.by.timeframe',
                        score: 0.9,
                        entities: [{
                            entity: 'timeframe',
                            resolution: { value: 'last-month' },
                            sourceText: 'last month'
                        }]
                    };
                }
                
                if (queryLower.includes('roof')) {
                    return {
                        intent: 'search.by.type',
                        score: 0.8,
                        entities: [{
                            entity: 'project-type',
                            resolution: { value: 'roof' },
                            sourceText: 'roof'
                        }]
                    };
                }
                
                if (queryLower.includes('customer') || queryLower.includes('john') || queryLower.includes('smith')) {
                    return {
                        intent: 'search.customer',
                        score: 0.8,
                        entities: [{
                            entity: 'any',
                            sourceText: queryLower.replace('customer', '').replace('find', '').trim()
                        }]
                    };
                }
                
                if (queryLower.includes('project') && /\d+/.test(queryLower)) {
                    return {
                        intent: 'search.project',
                        score: 0.8,
                        entities: [{
                            entity: 'any',
                            sourceText: queryLower.match(/\d+/)[0]
                        }]
                    };
                }
                
                return {
                    intent: 'None',
                    score: 0.3,
                    entities: []
                };
            }
        }

        // Mock search service
        class MockSearchService {
            constructor() {
                this.data = testData;
                this.nlpManager = new MockNLPManager();
            }

            async search(query) {
                const nlpResult = await this.nlpManager.process('en', query);
                
                if (nlpResult.score < 0.5) {
                    return this.conventionalSearch(query);
                }

                return this.structuredSearch(nlpResult, query);
            }

            structuredSearch(nlpResult, query) {
                const { intent, entities } = nlpResult;
                let results = [];

                switch (intent) {
                    case 'search.by.status':
                        const status = entities[0]?.resolution?.value;
                        results = this.data.projects.filter(p => {
                            if (status === 'completed') return p.status === 'COMPLETED';
                            if (status === 'in-progress') return p.status === 'IN_PROGRESS';
                            return false;
                        });
                        break;
                    
                    case 'search.by.phase':
                        const phase = entities[0]?.resolution?.value;
                        results = this.data.projects.filter(p => p.phase === phase);
                        break;
                    
                    case 'search.by.type':
                        const type = entities[0]?.resolution?.value;
                        results = this.data.projects.filter(p => 
                            p.projectType.includes(type) || p.name.toLowerCase().includes(type)
                        );
                        break;
                    
                    case 'search.customer':
                        const customerText = entities[0]?.sourceText || '';
                        results = this.data.projects.filter(p => 
                            p.customer.name.toLowerCase().includes(customerText.toLowerCase())
                        );
                        break;
                    
                    case 'search.project':
                        const projectText = entities[0]?.sourceText || '';
                        results = this.data.projects.filter(p => 
                            p.projectNumber.includes(projectText) || 
                            p.name.toLowerCase().includes(projectText.toLowerCase())
                        );
                        break;
                    
                    default:
                        results = this.conventionalSearch(query);
                        break;
                }

                return results.map(project => ({
                    id: project.id,
                    type: 'project',
                    category: 'Projects',
                    title: `Project #${project.projectNumber}`,
                    subtitle: project.customer.name,
                    description: project.address,
                    data: project,
                    nlp: {
                        intent,
                        isStructuredSearch: true,
                        confidence: nlpResult.score
                    }
                }));
            }

            conventionalSearch(query) {
                const results = this.data.projects.filter(p => 
                    p.projectNumber.includes(query) ||
                    p.name.toLowerCase().includes(query.toLowerCase()) ||
                    p.customer.name.toLowerCase().includes(query.toLowerCase()) ||
                    p.address.toLowerCase().includes(query.toLowerCase())
                );

                return results.map(project => ({
                    id: project.id,
                    type: 'project',
                    category: 'Projects',
                    title: `Project #${project.projectNumber}`,
                    subtitle: project.customer.name,
                    description: project.address,
                    data: project,
                    nlp: {
                        isStructuredSearch: false
                    }
                }));
            }
        }

        const searchService = new MockSearchService();

        function testQuery(query) {
            searchInput.value = query;
            performSearch(query);
        }

        async function performSearch(query) {
            if (!query || query.length < 2) {
                resultsDiv.innerHTML = '<div class="loading">Enter at least 2 characters to search...</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">üîç Searching...</div>';

            try {
                const results = await searchService.search(query);
                displayResults(results, query);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Search failed: ${error.message}</div>`;
            }
        }

        function displayResults(results, query) {
            if (results.length === 0) {
                resultsDiv.innerHTML = `<div class="error">No results found for "${query}"</div>`;
                return;
            }

            const resultHtml = results.map(result => {
                const indicator = result.nlp?.isStructuredSearch 
                    ? '<span class="nlp-indicator">AI SEARCH</span>' 
                    : '<span class="conventional-indicator">KEYWORD</span>';
                
                return `
                    <div class="result-item">
                        <div class="result-title">${result.title} ${indicator}</div>
                        <div class="result-subtitle">${result.subtitle}</div>
                        <div>${result.description}</div>
                        <div class="result-meta">
                            ${result.nlp?.intent ? `Intent: ${result.nlp.intent} | ` : ''}
                            ${result.nlp?.confidence ? `Confidence: ${(result.nlp.confidence * 100).toFixed(0)}% | ` : ''}
                            Category: ${result.category} | 
                            Type: ${result.type}
                            ${result.nlp?.isStructuredSearch ? ' | ü§ñ Processed with NLP' : ' | üîç Keyword matching'}
                        </div>
                    </div>
                `;
            }).join('');

            resultsDiv.innerHTML = `
                <div class="success">
                    ‚úÖ Found ${results.length} result(s) for "${query}"
                </div>
                ${resultHtml}
            `;
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => performSearch(query), 300);
        });

        // Initialize with empty results
        resultsDiv.innerHTML = '<div class="loading">Enter a search query above to test the AI search...</div>';
    </script>
</body>
</html>