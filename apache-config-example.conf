# Apache Configuration for Roofing Project Application
# Location: /etc/apache2/sites-available/roofing-app.conf (Debian/Ubuntu)
# or: /etc/httpd/conf.d/roofing-app.conf (CentOS/RHEL)
#
# IMPORTANT: This is a reference configuration. Adjust paths and domains for your environment.
#
# Required Apache modules (enable before using this config):
# sudo a2enmod proxy proxy_http headers expires rewrite ssl
#
# After editing:
# 1. Test configuration: sudo apachectl configtest
# 2. Reload Apache: sudo systemctl reload apache2 (or httpd)
# 3. Check logs: sudo tail -f /var/log/apache2/error.log

<VirtualHost *:80>
    # IMPORTANT: Replace with your actual domain
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    
    # Server admin email
    ServerAdmin admin@your-domain.com
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/roofing-app-error.log
    CustomLog ${APACHE_LOG_DIR}/roofing-app-access.log combined
    
    # ========================================================================
    # STATIC FILE SERVING FOR UPLOADS
    # ========================================================================
    # This serves uploaded documents directly from Apache (bypasses Node.js)
    # for better performance and reduced server load
    
    # IMPORTANT: Replace this path with your actual uploads directory
    # Common paths on Digital Ocean:
    # - /var/www/roofing-app/uploads
    # - /home/deploy/roofing-app/uploads
    # - /app/uploads (if using Docker)
    Alias /uploads /var/www/your-app-name/uploads
    
    <Directory /var/www/your-app-name/uploads>
        # Allow access to this directory
        Require all granted
        
        # Disable directory listing (security)
        Options -Indexes +FollowSymLinks
        
        # Allow .htaccess overrides if needed
        AllowOverride None
        
        # Enable CORS for uploaded files (allows frontend to access files)
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, OPTIONS"
        Header set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept"
        
        # Cache uploaded files for 1 day (improves performance)
        ExpiresActive On
        ExpiresDefault "access plus 1 day"
        Header set Cache-Control "public, immutable"
        
        # Security headers
        Header set X-Content-Type-Options "nosniff"
        Header set X-Frame-Options "SAMEORIGIN"
        Header set X-XSS-Protection "1; mode=block"
        
        # Prevent execution of scripts in uploads directory (security)
        # This is CRITICAL to prevent malicious file uploads from being executed
        <FilesMatch "\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$">
            Require all denied
        </FilesMatch>
        
        # Force download for certain file types (optional)
        # <FilesMatch "\.(pdf|doc|docx|xls|xlsx)$">
        #     Header set Content-Disposition "attachment"
        # </FilesMatch>
    </Directory>
    
    # ========================================================================
    # PROXY TO NODE.JS APPLICATION
    # ========================================================================
    # All other requests are proxied to the Node.js/Express server
    
    # Preserve the original Host header
    ProxyPreserveHost On
    
    # Don't proxy /uploads requests (they're handled by Alias above)
    ProxyPass /uploads !
    
    # Proxy all other requests to Node.js
    # IMPORTANT: Adjust port if your Node.js app runs on a different port
    ProxyPass / http://localhost:5000/
    ProxyPassReverse / http://localhost:5000/
    
    # ========================================================================
    # WEBSOCKET SUPPORT (for Socket.io)
    # ========================================================================
    # Enable WebSocket proxying for real-time features
    
    RewriteEngine On
    
    # WebSocket upgrade
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:5000/$1 [P,L]
    
    # Regular HTTP
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://localhost:5000/$1 [P,L]
    
    # ========================================================================
    # OPTIONAL: SERVE REACT BUILD FILES FROM APACHE
    # ========================================================================
    # If you want Apache to serve your React build files instead of Node.js
    # (better performance), uncomment and configure this section:
    
    # DocumentRoot /var/www/your-app-name/build
    # 
    # <Directory /var/www/your-app-name/build>
    #     Require all granted
    #     Options -Indexes +FollowSymLinks
    #     AllowOverride None
    #     
    #     # React Router support (SPA)
    #     RewriteEngine On
    #     RewriteBase /
    #     RewriteRule ^index\.html$ - [L]
    #     RewriteCond %{REQUEST_FILENAME} !-f
    #     RewriteCond %{REQUEST_FILENAME} !-d
    #     RewriteRule . /index.html [L]
    #     
    #     # Cache static assets
    #     <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
    #         ExpiresActive On
    #         ExpiresDefault "access plus 1 year"
    #         Header set Cache-Control "public, immutable"
    #     </FilesMatch>
    # </Directory>
    # 
    # # API requests go to Node.js
    # ProxyPass /api/ http://localhost:5000/api/
    # ProxyPassReverse /api/ http://localhost:5000/api/
</VirtualHost>

# ============================================================================
# SSL/HTTPS CONFIGURATION (RECOMMENDED FOR PRODUCTION)
# ============================================================================
# After setting up SSL with Let's Encrypt (certbot), add this configuration:

# <IfModule mod_ssl.c>
# <VirtualHost *:443>
#     ServerName your-domain.com
#     ServerAlias www.your-domain.com
#     ServerAdmin admin@your-domain.com
#     
#     # SSL certificates (managed by certbot)
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/your-domain.com/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/your-domain.com/privkey.pem
#     Include /etc/letsencrypt/options-ssl-apache.conf
#     
#     # ... (same configuration as above)
#     
#     ErrorLog ${APACHE_LOG_DIR}/roofing-app-ssl-error.log
#     CustomLog ${APACHE_LOG_DIR}/roofing-app-ssl-access.log combined
# </VirtualHost>
# </IfModule>
# 
# # Redirect HTTP to HTTPS
# <VirtualHost *:80>
#     ServerName your-domain.com
#     ServerAlias www.your-domain.com
#     Redirect permanent / https://your-domain.com/
# </VirtualHost>

# ============================================================================
# INSTALLATION INSTRUCTIONS
# ============================================================================
# 
# 1. Enable required Apache modules:
#    Debian/Ubuntu:
#      sudo a2enmod proxy proxy_http headers expires rewrite ssl
#    CentOS/RHEL:
#      Modules are typically enabled by default, but verify in httpd.conf
# 
# 2. Copy this file to Apache sites-available:
#    Debian/Ubuntu:
#      sudo cp apache-config-example.conf /etc/apache2/sites-available/roofing-app.conf
#    CentOS/RHEL:
#      sudo cp apache-config-example.conf /etc/httpd/conf.d/roofing-app.conf
# 
# 3. Edit the file and replace placeholders:
#    Debian/Ubuntu:
#      sudo nano /etc/apache2/sites-available/roofing-app.conf
#    CentOS/RHEL:
#      sudo nano /etc/httpd/conf.d/roofing-app.conf
#    - Replace "your-domain.com" with your actual domain
#    - Replace "/var/www/your-app-name/uploads" with your actual uploads path
#    - Adjust port (5000) if your Node.js app uses a different port
# 
# 4. Enable the site (Debian/Ubuntu only):
#    sudo a2ensite roofing-app.conf
# 
# 5. Test Apache configuration:
#    sudo apachectl configtest
# 
# 6. Reload Apache:
#    Debian/Ubuntu:
#      sudo systemctl reload apache2
#    CentOS/RHEL:
#      sudo systemctl reload httpd
# 
# 7. Check Apache status:
#    Debian/Ubuntu:
#      sudo systemctl status apache2
#    CentOS/RHEL:
#      sudo systemctl status httpd
# 
# 8. Monitor logs for issues:
#    Debian/Ubuntu:
#      sudo tail -f /var/log/apache2/error.log
#    CentOS/RHEL:
#      sudo tail -f /var/log/httpd/error_log
# 
# 9. Test file access:
#    curl -I https://your-domain.com/uploads/company-assets/test.pdf
# 
# ============================================================================
# TROUBLESHOOTING
# ============================================================================
# 
# Issue: 404 Not Found
# - Verify the Alias path is correct: ls -la /var/www/your-app-name/uploads/
# - Check Apache error log: sudo tail -f /var/log/apache2/error.log
# - Ensure files exist in the correct location
# - Verify Alias directive is before ProxyPass directives
# 
# Issue: 403 Forbidden
# - Check file permissions: sudo chmod -R 755 /var/www/your-app-name/uploads
# - Check ownership:
#     Debian/Ubuntu: sudo chown -R www-data:www-data /var/www/your-app-name/uploads
#     CentOS/RHEL: sudo chown -R apache:apache /var/www/your-app-name/uploads
# - Verify Apache user has read access:
#     Debian/Ubuntu: sudo -u www-data ls /var/www/your-app-name/uploads/
#     CentOS/RHEL: sudo -u apache ls /var/www/your-app-name/uploads/
# - Check SELinux (CentOS/RHEL):
#     sudo setenforce 0  # Temporarily disable to test
#     sudo setsebool -P httpd_read_user_content 1  # Permanent fix
# 
# Issue: 502 Bad Gateway
# - Verify Node.js app is running: sudo systemctl status your-app-service
# - Check if port 5000 is listening: sudo netstat -tlnp | grep 5000
# - Review Node.js logs: sudo journalctl -u your-app-service -f
# - Verify proxy modules are enabled: apache2ctl -M | grep proxy
# 
# Issue: WebSocket connection fails
# - Ensure mod_proxy_wstunnel is enabled: sudo a2enmod proxy_wstunnel
# - Verify RewriteEngine is On
# - Check browser console for WebSocket errors
# - Review Apache error log for proxy errors
# 
# Issue: "AH00526: Syntax error" when testing config
# - Check for typos in directives
# - Ensure all required modules are enabled
# - Verify file paths exist and are accessible
# 
# ============================================================================

