<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Production PM Assignment</title>
</head>
<body>
    <h1>Test Production Project Manager Assignment</h1>
    <div>
        <label>Production URL:</label>
        <input type="text" id="productionUrl" placeholder="https://your-app.ondigitalocean.app" style="width: 300px; margin: 10px;">
        <button id="testPM">Test PM Assignment</button>
    </div>
    <div id="result" style="margin-top: 20px; padding: 20px; border: 1px solid #ccc; background: #f9f9f9;"></div>

    <script>
        document.getElementById('testPM').addEventListener('click', async () => {
            const resultDiv = document.getElementById('result');
            const productionUrl = document.getElementById('productionUrl').value.trim();
            
            if (!productionUrl) {
                resultDiv.innerHTML = '<h3>‚ùå ERROR</h3><p>Please enter your DigitalOcean production URL</p>';
                return;
            }
            
            resultDiv.innerHTML = 'Testing production PM assignment...';
            
            try {
                const apiBaseUrl = `${productionUrl}/api`;
                console.log('Testing with API base:', apiBaseUrl);
                
                // Test 1: Get team members to verify David Chen exists
                console.log('Step 1: Getting team members...');
                const usersResponse = await fetch(`${apiBaseUrl}/users/team-members`, {
                    headers: { 
                        'Authorization': 'Bearer demo-debug-token',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!usersResponse.ok) {
                    throw new Error(`Team members API failed: ${usersResponse.status} ${usersResponse.statusText}`);
                }
                
                const usersResult = await usersResponse.json();
                console.log('Users result:', usersResult);
                
                if (!usersResult.success || !usersResult.data?.teamMembers) {
                    throw new Error('Failed to get team members from API');
                }
                
                const davidChen = usersResult.data.teamMembers.find(u => 
                    u.firstName === 'David' && u.lastName === 'Chen'
                );
                
                if (!davidChen) {
                    throw new Error('David Chen not found in team members');
                }
                
                console.log('Found David Chen:', davidChen);
                
                // Test 2: Create a simple test project to verify PM assignment
                console.log('Step 2: Creating test customer...');
                const customerData = {
                    primaryName: 'PM Production Test',
                    primaryEmail: 'pmtest@production.com', 
                    primaryPhone: '(555) 888-9999',
                    address: 'Production Test Address, Denver, CO 80202'
                };
                
                const customerResponse = await fetch(`${apiBaseUrl}/customers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer demo-debug-token'
                    },
                    body: JSON.stringify(customerData)
                });
                
                if (!customerResponse.ok) {
                    throw new Error(`Customer creation failed: ${customerResponse.status}`);
                }
                
                const customerResult = await customerResponse.json();
                console.log('Customer created:', customerResult);
                
                if (!customerResult.success) {
                    throw new Error(`Customer creation failed: ${customerResult.message}`);
                }
                
                // Test 3: Create project with David Chen as PM
                console.log('Step 3: Creating project with David Chen as PM...');
                const projectData = {
                    projectNumber: Math.floor(Math.random() * 90000) + 10000, // Random 5-digit number
                    projectName: 'Production PM Test Project',
                    projectType: 'ROOFING',
                    customerId: customerResult.data.id,
                    projectManagerId: davidChen.id, // This is the key test
                    status: 'PENDING',
                    budget: 8500,
                    startDate: new Date().toISOString(),
                    endDate: new Date(Date.now() + 45 * 24 * 60 * 60 * 1000).toISOString(),
                    priority: 'HIGH',
                    description: 'Production test to verify David Chen PM assignment works'
                };
                
                console.log('Project data being sent:', projectData);
                
                const projectResponse = await fetch(`${apiBaseUrl}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer demo-debug-token'
                    },
                    body: JSON.stringify(projectData)
                });
                
                console.log('Project response status:', projectResponse.status);
                
                const projectResult = await projectResponse.json();
                console.log('Project result:', projectResult);
                
                if (!projectResponse.ok) {
                    throw new Error(`Project creation failed: ${projectResponse.status} - ${projectResult.message || 'Unknown error'}`);
                }
                
                if (!projectResult.success) {
                    throw new Error(`Project creation failed: ${projectResult.message}`);
                }
                
                // Analyze results
                const project = projectResult.data;
                const assignedPM = project.projectManager;
                const pmAssignedCorrectly = assignedPM && assignedPM.id === davidChen.id;
                
                resultDiv.innerHTML = `
                    <h3>${pmAssignedCorrectly ? '‚úÖ SUCCESS' : '‚ùå FAILURE'}</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <h4>Test Results:</h4>
                        <p><strong>Production URL:</strong> ${productionUrl}</p>
                        <p><strong>David Chen Found:</strong> ‚úÖ Yes (Role: ${davidChen.role})</p>
                        <p><strong>David Chen ID:</strong> ${davidChen.id}</p>
                        <p><strong>Project Created:</strong> ${project.projectName} (#${project.projectNumber})</p>
                        <p><strong>Requested PM ID:</strong> ${projectData.projectManagerId}</p>
                        <p><strong>Assigned PM:</strong> ${assignedPM ? `${assignedPM.firstName} ${assignedPM.lastName} (${assignedPM.id})` : 'None assigned'}</p>
                        <p><strong>Assignment Match:</strong> ${pmAssignedCorrectly ? '‚úÖ Correct' : '‚ùå Incorrect'}</p>
                    </div>
                    
                    ${pmAssignedCorrectly ? `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; border-radius: 5px;">
                            üéâ <strong>SUCCESS!</strong> David Chen is now being properly assigned as Project Manager in production!
                        </div>
                    ` : `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 5px;">
                            ‚ùå <strong>ISSUE:</strong> David Chen is still not being assigned properly. The role fix may not have been applied to production yet.
                        </div>
                    `}
                    
                    <details style="margin-top: 15px;">
                        <summary>Debug Information</summary>
                        <h5>David Chen User Data:</h5>
                        <pre>${JSON.stringify(davidChen, null, 2)}</pre>
                        
                        <h5>Project Data Sent:</h5>
                        <pre>${JSON.stringify(projectData, null, 2)}</pre>
                        
                        <h5>Project Data Received:</h5>
                        <pre>${JSON.stringify(project, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                console.error('Test error:', error);
                resultDiv.innerHTML = `
                    <h3>‚ùå ERROR</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Production URL:</strong> ${productionUrl}</p>
                    <p>Make sure:</p>
                    <ul>
                        <li>The production URL is correct (should end with .ondigitalocean.app)</li>
                        <li>The production server is running</li>
                        <li>The database role fix was applied to production</li>
                    </ul>
                    <details>
                        <summary>Full Error Details</summary>
                        <pre>${error.stack || error.toString()}</pre>
                    </details>
                `;
            }
        });
        
        // Auto-populate common DigitalOcean URL pattern
        document.addEventListener('DOMContentLoaded', () => {
            const urlInput = document.getElementById('productionUrl');
            // You can update this with your actual production URL
            urlInput.placeholder = 'https://your-app-name.ondigitalocean.app';
        });
    </script>
</body>
</html>